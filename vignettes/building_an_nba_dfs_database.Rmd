---
title: "Building an NBA DFS Database"
author: "M. Edward (Ed) Borasky"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
library(magrittr)
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

## Creating the database
The first order of business is to create an empty database to hold out NBA data. We use SQLite.

```{r}
connection <- DBI::dbConnect(drv = RSQLite::SQLite(), dbname = "nba_data.sqlite")
print(connection)

if (DBI::dbExistsTable(connection, "nba_games")) {
  DBI::dbRemoveTable(connection, "nba_games")
}
DBI::dbListTables(connection)
```

## Getting the past seasons
The MySportsFeeds API has DFS data for all NBA seasons from the 2015-2016 regular seasons. So we create a list of those seasons and then fetch them and add them to the database.

```{r}
seasons <- c(
  "2015-2016-regular",
  "2016-playoff",
  "2016-2017-regular",
  "2017-playoff",
  "2017-2018-regular",
  "2018-playoff"
)

# you will need to set the enviromnment variable `APIKEY` to your MySportsFeeds API v2.0 API key
apikey <- Sys.getenv("APIKEY")
for (ixseason in seasons) {
  games <-
    dfstools::msf_seasonal_games("nba", ixseason, apikey)$games
  games <- games %>%
    dplyr::select(
      -schedule.endedTime,
      -schedule.originalStartTime,
      -schedule.delayedOrPostponedReason,
      -schedule.attendance:-schedule.weather,
      -score.currentQuarter:-score.currentIntermission,
      -score.quarters
    )
  if (ixseason == "2015-2016-regular") {
    DBI::dbCreateTable(connection, "nba_games", games)
    
    # dbCreateTable creates an empty table, so we append the data
    DBI::dbAppendTable(connection, "nba_games", games)
    teams <- games %>% dplyr::select(schedule.homeTeam.abbreviation) %>% 
      dplyr::distinct() %>%
      dplyr::select(team = schedule.homeTeam.abbreviation) %>% 
      dplyr::arrange(team)
  } else {
    DBI::dbAppendTable(connection, "nba_games", games)
  }
}

print(teams)

DBI::dbDisconnect(connection)
```

## Get the player game logs (box scores) one team at a time

